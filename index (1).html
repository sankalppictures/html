<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
  <title>No Internet Clone + Leaderboard (Supabase)</title>
  <style>
    body{margin:0;background:#fff;font-family:Arial,Helvetica,sans-serif;overflow-x:hidden}
    .scoreboard{position:fixed;top:10px;right:15px;font:700 20px/1 monospace;color:#111;z-index:10}
    .game{position:relative;width:100%;height:50vh;border-bottom:5px solid #ccc;overflow:hidden;background:#fff}
    #character{position:absolute;bottom:0;left:15vw;width:80px;height:auto}
    .obstacle{position:absolute;bottom:0;left:100%;width:39px;height:50px}
    .cloud{position:absolute;top:90px;left:100%;width:120px;height:auto;opacity:.7;animation:cloud 5s linear infinite}
    @keyframes cloud{from{left:100%}to{left:-120px}}
    #leaderboard{padding:15px;border-top:2px solid #eee;background:#fafafa;font:16px monospace}
    #leaderboard h2{margin:0 0 10px}
    #leaderboard p{margin:3px 0}
  </style>
</head>
<body>
  <div class="scoreboard">SCORE: <span id="score">0</span> | HI: <span id="hiscore">0</span></div>

  <div class="game" id="game">
    <img id="character" src="https://i.ibb.co/N6syYKBp/image-removebg-preview.png" alt="character">
    <img class="obstacle" id="obstacle" src="https://i.ibb.co/tTSKZTnT/images-1-removebg-preview.png" alt="obstacle">
    <img class="cloud" src="https://i.ibb.co/ccPtdvPn/images-3-removebg-preview.png" alt="cloud">
  </div>

  <div id="leaderboard">
    <h2>üèÜ Leaderboard</h2>
    <div id="boardList">Loading...</div>
  </div>

  <!-- Supabase (global) -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // ‚¨áÔ∏è Apna URL/Key yahan daalo
    const SUPABASE_URL = "https://ktuyvqnkgsdvyfgvwer.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0dXl2cW5rZ2RzZHZmeWd2ZXdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NTczMzcsImV4cCI6MjA3MjAzMzMzN30.PdyQveCaHdh8eYEal0PGdMUELssA65-0fegPhxVM-DQ";
    const TABLE_NAME = "Scores"; // agar table lowercase 'scores' hai to yahan bhi 'scores' kar do

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM refs
    const character = document.getElementById("character");
    const obstacle = document.getElementById("obstacle");
    const scoreEl = document.getElementById("score");
    const hiscoreEl = document.getElementById("hiscore");
    const board = document.getElementById("boardList");

    // Game state
    let jumping = false;
    let score = 0;
    let hiscore = Number(localStorage.getItem("hiscore") || 0);
    let obsX = window.innerWidth;
    let speed = 6;
    let gameOver = false;      // ‚ö†Ô∏è important: prevents repeated prompts
    let deadCooldown = false;  // small delay after reset

    hiscoreEl.textContent = hiscore;

    function jump(){
      if (jumping || gameOver) return;
      jumping = true;
      let pos = 0;
      const up = setInterval(()=>{
        if (pos >= 219){
          clearInterval(up);
          const down = setInterval(()=>{
            if (pos <= 0){ clearInterval(down); jumping = false; }
            pos -= 10; character.style.bottom = pos + "px";
          },20);
        }
        pos += 10; character.style.bottom = pos + "px";
      },20);
    }

    function resetObstacle() {
      obsX = window.innerWidth + 120; // push far right so no instant collision
      obstacle.style.left = obsX + "px";
    }

    async function saveScore(name, sc){
      try{
        const { error } = await sb.from(TABLE_NAME).insert([{ name, score: sc }]);
        if (error) { console.error("Insert error:", error); alert("Score save failed: " + error.message); }
      }catch(e){
        console.error(e);
      }finally{
        loadLeaderboard();
      }
    }

    async function loadLeaderboard(){
      const { data, error } = await sb.from(TABLE_NAME)
        .select("*")
        .order("score", { ascending: false })
        .limit(10);
      if (error){ console.error("Load error:", error); board.textContent = "Error loading leaderboard"; return; }
      board.innerHTML = data.map((r,i)=>`<p>${i+1}. ${r.name} ‚Äî ${r.score}</p>`).join("") || "<p>No scores yet</p>";
    }

    function handleGameOver(){
      if (gameOver || deadCooldown) return; // already handled
      gameOver = true;

      // Freeze obstacle exactly where it is to avoid moving during prompt
      obstacle.style.left = obsX + "px";

      const raw = prompt("Game Over! ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç (max 16 chars):");
      const playerName = (raw || "Player").trim().slice(0,16);

      if (playerName) saveScore(playerName, score);

      // reset run
      score = 0; scoreEl.textContent = score;
      character.style.bottom = "0px";
      resetObstacle();

      // small cooldown to stop instant re-trigger
      deadCooldown = true;
      setTimeout(()=>{ deadCooldown = false; gameOver = false; }, 800);
    }

    // Game loop
    setInterval(()=>{
      // move obstacle only if not game over
      if (!gameOver){
        obsX -= speed;
        obstacle.style.left = obsX + "px";
      }

      // obstacle passed -> increase score
      if (obsX < -60){
        resetObstacle();
        score++; scoreEl.textContent = score;
        if (score > hiscore){ hiscore = score; localStorage.setItem("hiscore", hiscore); hiscoreEl.textContent = hiscore; }
      }

      // Skip collision checks during cooldown
      if (deadCooldown) return;

      // Collision detection
      const charBottom = parseInt(getComputedStyle(character).getPropertyValue("bottom"));
      const charLeft = character.offsetLeft;
      const charRight = charLeft + character.offsetWidth;
      const obsLeft = obsX;
      const obsRight = obsX + obstacle.offsetWidth;

      const overlapX = (charRight > obsLeft) && (charLeft < obsRight);
      const overlapY = (charBottom < obstacle.offsetHeight);

      if (overlapX && overlapY){
        handleGameOver();
      }
    },30);

    // Controls
    document.addEventListener("keydown", e=>{
      if (e.code === "Space" || e.code === "ArrowUp") jump();
    });
    document.addEventListener("click", jump);

    // First load
    resetObstacle();
    loadLeaderboard();

    // Optional: window helper to test save quickly
    window.testInsert = ()=>saveScore("Test", Math.floor(Math.random()*100));
  </script>
</body>
</html>